name: Prueba Final Caro - Inteligencia Total
on:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rastrear Proyecto e Instalar
        run: |
          # 1. Buscamos el proyecto (restringimos a analytics para que no se distraiga con database)
          PROYECTO_PATH=$(find ./analytics -name "*.xcodeproj" | head -n 1)
          DIRECTORIO=$(dirname "$PROYECTO_PATH")
          NOMBRE_PROYECTO=$(basename "$PROYECTO_PATH")
          NOMBRE_TARGET=$(basename "$PROYECTO_PATH" .xcodeproj)
          
          echo "Directorio: $DIRECTORIO"
          echo "Proyecto: $NOMBRE_PROYECTO"
          echo "Target: $NOMBRE_TARGET"
          
          cd "$DIRECTORIO"
          
          # 2. Creamos el Podfile usando las variables autom√°ticas
          cat <<EOF > Podfile
          platform :ios, '15.0'
          project '$NOMBRE_PROYECTO'
          use_frameworks!
          target '$NOMBRE_TARGET' do
            pod 'FirebaseAnalytics'
          end
          EOF
          
          pod install

      - name: Compilar para Simulador
        run: |
          PROYECTO_PATH=$(find ./analytics -name "*.xcodeproj" | head -n 1)
          DIRECTORIO=$(dirname "$PROYECTO_PATH")
          NOMBRE_TARGET=$(basename "$PROYECTO_PATH" .xcodeproj)
          cd "$DIRECTORIO"
          
          WORKSPACE=$(ls | grep .xcworkspace)
          
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$NOMBRE_TARGET" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            -quiet

      - name: Guardar App para Appetize
        uses: actions/upload-artifact@v4
        with:
          name: app-simulador
          path: "**/build/Build/Products/Debug-iphonesimulator/*.app"
